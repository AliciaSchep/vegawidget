---
title: "Visual Regression"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

The purpose of this document is to use our eyeballs to vaildate the rendering of vegaspecs as vegawidgets and images. This will be a very boring document, as we are going to see the same specification rendered ad-naseum.

For the image tests, we use explicity test the functions `vw_write_png()` and `vw_write_svg()`. We note the complimentary functions `to_png()` and `to_svg()`; these are implicitly tested as they are the used by the `vw_write_png()` and `vw_write_svg()` functions.

```{r}
library("conflicted")
library("vegawidget")
```

```{r}
dir_img <- "visual-regression-files"

if (fs::dir_exists(dir_img)) {
  fs::dir_delete(dir_img)
}

fs::dir_create(dir_img)
```

## Reference 

Our reference is this `mtcars` scatterplot. We expect it to be rendered with a plotting area with `width = 300` and `height = 300`.

```{r}
spec_mtcars
```

## Autosize 

Next, we test using `vw_autosize()`. We expect that the rendered spec will have a *total* size of `width = 600` and `height = 300`.

```{r}
vw_autosize(spec_mtcars, width = 600, height = 300)
```

We exepct the same result using the `vegawidget()` function:

```{r}
vegawidget(spec_mtcars, width = 600, height = 300)
```

We expect the same result by setting `vega.width` and `vega.height` as knitr options, like so:

    ```{r vega.width=600, vega.height=300}
    spec_mtcars
    ```

```{r vega.width=600, vega.height=300}
spec_mtcars
```

## Vega

We expect this to be identical to the **reference** case, using the `vw_to_vega()` function to compile to a Vega specification:

```{r}
vw_to_vega(spec_mtcars)
```

## PNG

The function `vw_write_png()` generates an image at 96 DPI. We expect this to appear at the same size as the **reference**. However, we not using retina resolution so it will appear a bit fuzzy on non-retina monitors.

```{r}
file_png <- fs::path(dir_img, "mtcars-refrence.png")

vw_write_png(spec_mtcars, path = file_png)

knitr::include_graphics(file_png, dpi = 96)
```

To get retina resolution, we use the `scale` argument in `vw_write_png()`, then adjust the `dpi` argument in `include_graphics()`. Thus, we expect this to appear indentical to the **reference**. 

```{r}
file_png <- fs::path(dir_img, "mtcars-retina.png")

vw_write_png(spec_mtcars, path = file_png, scale = 2)

knitr::include_graphics(file_png, dpi = 96 * 2)
```

We expect that the rendered image will have a *total* size of `width = 600` and `height = 300`, but at non-retina resolution:

```{r}
file_png <- fs::path(dir_img, "mtcars-wide.png")

vw_write_png(spec_mtcars, path = file_png, width = 600, height = 300)

knitr::include_graphics(file_png, dpi = 96)
```

Finally, we expect to be able to use `vw_write_png()` with vegawidgets; we expect this to appear at the same size as the **reference**, but at non-retina resolution:

```{r}
file_png <- fs::path(dir_img, "mtcars-widget.png")

vw_write_png(vegawidget(spec_mtcars), path = file_png)

knitr::include_graphics(file_png, dpi = 96)
```

## SVG

The function `vw_to_svg()` generates a vector-image. We expect this to appear identical to the **reference**: 

```{r}
file_svg <- fs::path(dir_img, "mtcars-refrence.svg")

vw_write_svg(spec_mtcars, path = file_svg)

knitr::include_graphics(file_svg)
```

We expect that the rendered image will have a *total* size of `width = 600` and `height = 300`, and to appear at retina resolution.

```{r}
file_svg <- fs::path(dir_img, "mtcars-wide.svg")

vw_write_svg(spec_mtcars, path = file_svg, width = 600, height = 300)

knitr::include_graphics(file_svg)
```

The `scale` argument in `vw_write_svg()` may not be useful becuse the SVG itself is scalable. We expect this appear at double-size to **reference**, with retina resolution: 

```{r}
file_svg <- fs::path(dir_img, "mtcars-retina.svg")

vw_write_svg(spec_mtcars, path = file_svg, scale = 2)

knitr::include_graphics(file_svg)
```

Finally, we expect to be able to use `vw_write_svg()` with vegawidgets; we expect this to appear identical to the **reference**:

```{r}
file_svg <- fs::path(dir_img, "mtcars-widget.svg")

vw_write_svg(vegawidget(spec_mtcars), path = file_svg)

knitr::include_graphics(file_svg)
```
