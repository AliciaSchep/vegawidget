---
title: "Create images"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

The main purpose of this article is to demonstrate use this package's image-generating functions. A secondary purpose is  to help the package's developers confirm that these functions continue to work when things get changed. 

If [**node**]() is installed, you can use these image-generating functions to convert specs (or widgets) into SVG or bitmaps. With the [**rsvg**]() package additionally installed, one can write out to PNG format.  

We have four image-generating functions; they each take either a vegaspec or a vegawidget as their argument:

- `vw_to_bitmap()` returns a bitmap array that can be written to a PNG file
- `vw_to_svg()` returns a string for a SVG image
- `vw_write_png()` writes a PNG file, invisibly returns the vegaspec or vegawidget
- `vw_write_svg()` writes an SVG file, invisibly returns the vegaspec or vegawidget

As you can see, the function name indicates the action taken and the image-format.

In addition to a vegaspec or vegawidget, these are the principal arguments:

- `path`, for the image-writing functions, indicates the local path to which the file is to be written.

- `dpi`,`width`, and `height`, settings for the size and resolution of a PNG output image.


As you are most likely already aware, there is a tradeoff between PNG and SVG. The PNG format is an image with finite resolution. The SVG format is a set of instructions on how to render an image, so it has no resolution limitations. In general, the size of an SVG file scales with the number of graphical marks it contains, whereas a PNG file scales with its pixel-width and pixel-height.


```{r, message=FALSE}
library("vegawidget")
library("htmltools")
library("glue")
```

```{r include=FALSE}
library("fs")
library("here")
library("conflicted")

# note to developers - the only way that this html file will 
# compile properly is to use pkgdown::build_site() or 
# pkgdown::build_article() - do not use the knit button

prefix_image <- "visual-regression"
dir_write <- here::here("docs", "reference", "figures")
dir_read <- here::here("reference", "figures")

path_write <- function(x) {
  fs::path(dir_write, glue::glue("{prefix_image}-{x}"))
}

path_read <- function(x) {
  fs::path(dir_read, glue::glue("{prefix_image}-{x}"))
}

# clean out old files
to_delete <- 
  dir_ls(
    dir_write, 
    regexp = glue::glue("^{fs::path(dir_write, prefix_image)}")
  )

path_rel(to_delete, start = here())
file_delete(to_delete)
```

## Reference 

For the purpose of comparing later renderings, our reference is this `mtcars` scatterplot. It is rendered with a plotting area of `width = 300` and `height = 300`.

```{r}
spec_mtcars
```

## Bitmap & PNG

### To bitmap

The `vw_to_bitmap()` function returns a bitmap array. We can see the dimensions of the array:

```{r}
vw_to_bitmap(spec_mtcars) %>% dim()
```


```{r}
vw_to_bitmap(spec_mtcars, scale = 2) %>% dim()
```

### PNG output

The rest of the PNG demonstration focuses on the image-writing function, `vw_write_png()`, which uses `vw_to_bitmap()`. In the examples that follow, we use a couple of internal helper-functions, `path_write()` and `path_read()`, to manage the file-locations within the **pkgdown** framework. For the purpose of this demonstration please disregard these functions, please interpret this only as a means to provide a `path`.

### Normal scale

The function `vw_write_png()` generates an image at 96 DPI. We will write out a PNG file, then display it at the same resolution.

**Expectation**: the image will be rendered at the same size as the [reference](#reference). 

```{r}
filename <- "mtcars-refrence.png"

vw_write_png(spec_mtcars, path = path_write(filename))

knitr::include_graphics(path_read(filename))
```

```{r}
filename <- "mtcars-retina.png"
  
vw_write_png(spec_mtcars, path_write(filename), scale = 2)

# using knitr::include_graphics() with dpi not working, 
#  hacking a workaround

# determine the width of the image
meta <- png::readPNG(path_write(filename), info = TRUE)
width <- attr(meta, "info")[["dim"]][1]

# display width at half of image width
tags$img(src = path_read(filename), style = glue("width: {width / 2}px;"))
```

### Using vegawidget

This demonstrates how to use `vw_write_png()` with vegawidgets. 

**Expectation**: this image will appear at the same size as the [reference](#reference).

```{r}
filename <- "mtcars-widget.png"
  
vw_write_png(vegawidget(spec_mtcars), path = path_write(filename))

knitr::include_graphics(path_read(filename))
```

## SVG

### To string

The `vw_to_svg()` function returns an HTML string:

```{r}
vw_to_svg(spec_mtcars)
```

This string can be rendered as standard HTML:

```{r}
HTML(vw_to_svg(spec_mtcars))
```

### Normal scale

**Expectation**: this image will appear identical to the [reference](#reference): 

```{r}
filename <- "mtcars-refrence.svg"

vw_write_svg(spec_mtcars, path = path_write(filename))

knitr::include_graphics(path_read(filename))
```

### Autosize

**Expectation**: We expect that the rendered image will have a *total* size of `width = 600` and `height = 300`, and to appear at retina resolution.

```{r}
filename <- "mtcars-wide.svg"

vw_write_svg(spec_mtcars, path = path_write(filename), width = 600, height = 300)

knitr::include_graphics(path_read(filename))
```


### Vegawidget

As above, this demonstrates that we can expect use `vw_write_svg()` with vegawidgets. 

**Expectation**: this image will appear at the same size as the [reference](#reference).

```{r}
filename <- "mtcars-widget.svg"

vw_write_svg(vegawidget(spec_mtcars), path = path_write(filename))

knitr::include_graphics(path_read(filename))
```

## Other visual-regressions

Although the rest of these do not use images, they are included in this article to make it easier to verify that things render as we expect.

### Autosize 

Next, we test using `vw_autosize()`. 

**Expectation**: the rendered spec will have a *total* size of `width = 600` and `height = 300`.

```{r}
vw_autosize(spec_mtcars, width = 600, height = 300)
```

**Expectation**: we will get the same result using the `vegawidget()` function:

```{r}
vegawidget(spec_mtcars, width = 600, height = 300)
```

**Expectation**: we will get the same result by setting `vega.width` and `vega.height` as knitr options, like so:

    ```{r vega.width=600, vega.height=300}
    spec_mtcars
    ```

```{r vega.width=600, vega.height=300}
spec_mtcars
```

### Vega

**Expectation**: this will be identical to the [reference](#reference) case, using the `vw_to_vega()` function to compile to a Vega specification:

```{r}
vw_to_vega(spec_mtcars)
```
