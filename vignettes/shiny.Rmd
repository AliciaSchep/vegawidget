---
title: "Extend using Shiny"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r}
library("vegawidget")
```

The purpose of this article is to show how you can use Shiny to extend Vega's capabilities. In these examples, we use the [vega-view](https://github.com/vega/vega/tree/master/packages/vega-view) API to interact with a Vega chart using Shiny We explore similar ideas in an article on [extending using JavaScript](javascript.Rmd).

Because this is an HTML document (as opposed to a Shiny app), we cannot show the app directly in this document. However, this package offers a function `vw_shiny_demo()` that, when called without arguments, lists all of the demonstration apps included with this package; to run a particular app, simply use its name as the argument:

```r
vw_shiny_demo("data-set")
```

Once a Vega chart is built, there are three things you can access:

- [events](https://vega.github.io/vega/docs/api/view/#event-handling):`vw_shiny_get_event()`
- [signals](https://vega.github.io/vega/docs/api/view/#signals): using `vw_shiny_get_signal()` and `vw_shiny_set_signal()`
- [data](https://vega.github.io/vega/docs/api/view/#data-and-scales): using `vw_shiny_set_data()`

As we go through the examples, please keep in mind:

- the `vw_shiny_get_*()` functions **return reactive expressions**.
- the `vw_shiny_set_*()` functions **act as Shiny observers**.

## Getting events {#events}

This is a shortened version of the [events section](javascript.html#events) in the [JavaScript article](JavaScript); the concepts are the same, but the implemetation is far simpler using Shiny.

Event streams are [used extensively within Vega](https://vega.github.io/vega/docs/event-streams), enabling interactivity. By [adding event-listeners](https://vega.github.io/vega/docs/api/view/#view_addEventListener) to the `view`, we can specify actions to be taken in response to a particular type of event, such as `"mouseover"`, `"click"`, `"keypress"`, etc.

The Shiny demo, `vw_shiny_demo("event-get")`, features a scatterplot. When a mark on the chart is clicked, it returns to Shiny the data observation (datum) assocated with that mark.

The operative function in the `server()` function is `vw_shiny_get_event()`. Here it is in the context of the app:

```r
# the event returns the backing-data as a list
rct_list_click <-
  vw_shiny_get_event("chart", event = "click", body_value = "datum")
```

The function is called with three arguments:

- `outputId` - the scatterplot has the outputId `"chart"`
- `event` - we want to respond to `"click"` events on the scatterplot
- `body_value` - please see the following text...

The vega-view API requires that you supply a handler-function when you [add an event listener](https://vega.github.io/vega/docs/api/view/#view_addEventListener). Inconveniently for R users, this handler-function has to be JavaScript. This package does a few things to make working with JavaScript handlers a little easier.

An event-handler function is expected to have two arguments, `event` instance and the scenegraph `item`. Because all possible event handlers will have the same arguments, we need only specify the *body* of the function in `vw_shiny_get_event()`.

Instead of specifying the entire body of a JavaScript function, this package provides a library of bodies of (what we think are) commonly-used handler functions. To see the available event-handlers, call `vw_handler_event()` without arguments:

```{r}
vw_handler_event()
```

We wish to return the data-observation behind the mark associated with the event, so we can specify to `"datum"` handler. The `vw_shiny_get_event()` function knows to check the library first, so you can either supply the entire body of a JavaScript handler-function, or you can supply the name of a handler-function in the library.

The code supplied for `body_value` need only return a *value* - the `vw_shiny_get_event()` function will take care of composing this with additional code that will make that *value* available to Shiny.

Finally, the `vw_shiny_get_event()` function returns a reactive expression that evaluates to the latest *value* returned from the event-handler.

## Setting and getting signals

## Setting (and soon getting) data


Shiny interaction support in vegawidget and this vignette are still a work in progress.  

Currently supported are:

* `vw_add_event_listener` to add an event listener, where event is something like 'click' or 'hover'
* `vw_add_signal_listener` to addd a signal listener to listen to a vega signal
* `vw_bind_ui` to bind a shiny UI element to a vega signal, so that when the UI element is updated, the value is pushed to the signal 

To see examples of `vw_add_event_listener` and `vw_bind_ui`, see the app in the test_app of the repository.

## Listeners

The two functions to create listeners by default add a listener that will push the relavant data from the interaction/signal to shiny. If the widget has been created as `output$chart` then a 'click' event will update ` input$chart_click`.  Similarly, a listener for a signal named 'mysignal' would update `input$chart_mysignal`.

Alternatively, a custom listener function can be provided. That function should be a javascript with form `function(event,item)` for events and `function(name,value)` for signals.

At the moment, listeners are added at render time -- there is no support for adding a listner dynamically after having created the chart.  That functionality may be added in future, especially if a salient use case arises.

One would typically add a listener like this:

```{r, eval = FALSE}
vegawidget(spec) %>%
      vw_add_event_listener("click")
```

## Binding UI elements

`vw_bind_ui("chart", "slider", "cyl")` will bind the signal named "cyl" in the shiny output named "chart" to the value from the input named "slider".  Optionally, an input transformation function (in R) can be passed as well which will be applied to the input before passing it to the signal.

## Potential future functionality

### Selections

At present, it is not straightforward to listen to 'selections' in vega-lite. If refactoring & updates in vega-lite make it easier to access and listen to selections, then that functionality should get added to this package.

### insert and remove

The vega view api includes methods to insert or remove data from a plot. The internal `vw_call_vega_view` should be helpful for implementing this, but the format of the arguments has to be just right...  

### crosstalk or other inter-widget communication

Another potential area of future work is compatibility with crosstalk package.
